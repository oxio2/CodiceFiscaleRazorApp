@page "/"
@using CodiceFiscaleRazorApp.Services
@model CodiceFiscaleRazorApp.Pages.CodiceFiscaleModel
@{
    ViewData["Title"] = "Genera Codice Fiscale";
}

<h1>Modalità SSR</h1>
<form method="post" class="space-y-3" id="form-ssr">
    <div>
        <label asp-for="Cognome"></label>
        <input asp-for="Cognome" />
        <span asp-validation-for="Cognome"></span>
    </div>
    <div>
        <label asp-for="Nome"></label>
        <input asp-for="Nome" />
        <span asp-validation-for="Nome"></span>
    </div>
    <div>
        <label asp-for="DataNascita"></label>
        <input asp-for="DataNascita" type="date" />
        <span asp-validation-for="DataNascita"></span>
    </div>
    <div>
        <label asp-for="Comune"></label>
        <input asp-for="Comune" />
        <span asp-validation-for="Comune"></span>
    </div>
    <div>
        <label asp-for="Sesso"></label>
        <select asp-for="Sesso"
                asp-items="Html.GetEnumSelectList<CodiceFiscaleService.Sesso>()"></select>
        <span asp-validation-for="Sesso"></span>
    </div>

    <button type="submit">Calcola (SSR)</button>
</form>


@if (!string.IsNullOrEmpty(Model.CodiceFiscale))
{
    <div class="alert alert-success">
        <strong>Codice Fiscale:</strong> @Model.CodiceFiscale
    </div>
}

@if (!string.IsNullOrEmpty(Model.Errore))
{
    <div class="alert alert-danger">@Model.Errore</div>
}

<hr />

<h2>Modalità SPA (JS fetch)</h2>

<form id="form-js" class="space-y-3">
    <div>
        <label>Cognome</label>
        <input name="Cognome" required />
    </div>
    <div>
        <label>Nome</label>
        <input name="Nome" required />
    </div>
    <div>
        <label>Data di nascita</label>
        <input name="DataNascita" type="date" required />
    </div>
    <div>
        <label>Comune</label>
        <input name="Comune" required />
    </div>
    <div>
        <label>Sesso</label>
        <select name="Sesso">
            <option value="Maschio">Maschio</option>
            <option value="Femmina">Femmina</option>
        </select>
    </div>

    <button type="submit">Calcola (Fetch)</button>
</form>

<pre id="result-js" style="margin-top:1rem;"></pre>

@section Scripts {
    <script>
        document.getElementById('form-js')?.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const payload = {
            Cognome: fd.get('Cognome'),
            Nome: fd.get('Nome'),
            DataNascita: fd.get('DataNascita'), // yyyy-MM-dd
            Comune: fd.get('Comune'),
            Sesso: fd.get('Sesso') // "Maschio" | "Femmina"
          };

          const res = await fetch('/api/codice-fiscale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const out = document.getElementById('result-js');
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            out.textContent = 'Errore: ' + (err.error || res.statusText);
            return;
          }

          const data = await res.json();
          out.textContent = 'Codice Fiscale: ' + data.codiceFiscale;
        });
    </script>
}
